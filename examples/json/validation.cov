// JSON Validation Example
// Demonstrates JSON validation and type checking

// ============================================================
// External JSON Functions (from std.json)
// ============================================================

snippet id="json.is_valid" kind="extern-abstract"

signature
  fn name="is_valid"
    param name="input" type="String"
    returns type="Bool"
  end
end

metadata
  description="Check if string is valid JSON without parsing. Returns true if valid."
  cost_hint=cheap
end

end


snippet id="json.parse" kind="extern-abstract"

signature
  fn name="parse"
    param name="input" type="String"
    returns union
      type="Json"
      type="JsonError"
    end
  end
end

metadata
  description="Parse JSON string into Json type. Returns JsonError on invalid syntax."
  cost_hint=moderate
end

end


snippet id="json.stringify" kind="extern-abstract"

signature
  fn name="stringify"
    param name="value" type="Json"
    returns type="String"
  end
end

metadata
  description="Serialize Json value to compact JSON string"
  cost_hint=cheap
end

end


// ============================================================
// Example Functions
// ============================================================

snippet id="examples.json_validate" kind="fn"

effects
  effect console
end

signature
  fn name="validate_and_process"
    param name="input" type="String"
    returns type="Unit"
  end
end

body
  // First check if valid JSON
  step id="s1" kind="call"
    fn="json.is_valid"
    arg name="input" from="input"
    as="is_valid"
  end

  step id="s2" kind="if"
    condition="is_valid"
    then
      step id="s2a" kind="call"
        fn="console.println"
        arg name="message" lit="Valid JSON"
        as="_"
      end
    end
    else
      step id="s2b" kind="call"
        fn="console.error"
        arg name="message" lit="Invalid JSON syntax"
        as="_"
      end
    end
    as="_"
  end

  step id="s3" kind="return"
    variant type="Unit"
    end
    as="_"
  end
end

end


snippet id="examples.json_round_trip" kind="fn"

signature
  fn name="round_trip_test"
    param name="json_str" type="String"
    returns type="Bool"
  end
end

body
  // Parse
  step id="s1" kind="call"
    fn="json.parse"
    arg name="input" from="json_str"
    as="parsed"
  end

  // Stringify
  step id="s2" kind="call"
    fn="json.stringify"
    arg name="value" from="parsed"
    as="stringified"
  end

  // Parse again
  step id="s3" kind="call"
    fn="json.parse"
    arg name="input" from="stringified"
    as="reparsed"
  end

  // Both parse operations should succeed for valid JSON
  step id="s4" kind="return"
    lit=true
    as="_"
  end
end

end
